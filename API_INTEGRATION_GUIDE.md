# دليل تكامل API - RKS Order Bot 🌐

## نظرة عامة

تم إضافة ميزة تكامل API إلى البوت لإرسال الطلبات الجديدة تلقائياً إلى النظام الخارجي عبر API.

## المميزات الجديدة ✨

### 1. إرسال تلقائي للطلبات
- كل طلب جديد يتم إضافته عبر البوت سيتم إرساله تلقائياً إلى API
- يتم تسجيل حالة الإرسال في قاعدة البيانات المحلية
- عرض حالة API في رسالة التأكيد

### 2. مراقبة حالة API
- خيار جديد "🌐 حالة API" في قائمة المدير
- عرض الطلبات الفاشلة في الإرسال
- إمكانية إعادة المحاولة للطلبات الفاشلة
- اختبار الاتصال بـ API

### 3. تتبع الطلبات
- جدول جديد `api_orders` لتتبع الطلبات المرسلة
- تسجيل معرف الطلب من API
- تتبع عدد المحاولات للطلبات الفاشلة

## الإعداد والتكوين ⚙️

### 1. إعدادات API في config.py

```python
# API Settings
API_ENABLED = True  # تفعيل/إلغاء تفعيل إرسال الطلبات إلى API
API_BASE_URL = "https://rocklis.com/api/v1/admin/order/create"
API_USERNAME = "admin"  # اسم المستخدم للـ API
API_PASSWORD = "admin123"  # كلمة المرور للـ API
API_TIMEOUT = 30  # مهلة الاتصال بالثواني
```

### 2. اختبار الاتصال

```bash
python test_api_connection.py
```

## كيفية الاستخدام 📱

### للموظفين العاديين:
- لا يوجد تغيير في الاستخدام
- الطلبات الجديدة ستتم إرسالها تلقائياً إلى API
- ستظهر حالة API في رسالة التأكيد

### للمديرين:
1. **عرض حالة API**: اختر "🌐 حالة API" من القائمة
2. **مراقبة الطلبات الفاشلة**: عرض الطلبات التي فشلت في الإرسال
3. **إعادة المحاولة**: زر "🔄 إعادة المحاولة للطلبات الفاشلة"
4. **اختبار الاتصال**: عرض حالة الاتصال بـ API

## رسائل التأكيد الجديدة 📋

### عند نجاح الإرسال:
```
✅ تم إضافة الفاتورة بنجاح!

📋 تفاصيل الفاتورة:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 رقم الإيصال: INV-20240115123456
👤 اسم الموظفة: نور
👥 أسم العميل: محمد
🏛️ المحافظة: الانبار
📍 أقرب نقطة دالة: الرمادي
📞 الرقم: 0782444
📦 العدد: 1
💰 السعر: 40,000 دينار
📝 الملاحظات: لاشيئ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏰ التاريخ: 2024-01-15 12:34

🌐 حالة API:
✅ تم إرسال الطلب إلى النظام الخارجي بنجاح
🆔 معرف الطلب: 12345
📋 مجموعة الطلب: API-1703123456-1234
```

### عند فشل الإرسال:
```
🌐 حالة API:
❌ فشل في إرسال الطلب إلى النظام الخارجي
⚠️ السبب: خطأ في الاتصال بالخادم
💡 سيتم إعادة المحاولة تلقائياً
```

## مراقبة حالة API 📊

### عرض الطلبات الفاشلة:
```
🌐 حالة API - الطلبات الفاشلة
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 عدد الطلبات الفاشلة: 3

📋 آخر 5 طلبات فاشلة:

1. رقم الإيصال: INV-20240115123456
   👤 الموظف: نور
   👥 العميل: محمد
   💰 المبلغ: 40,000 دينار
   ⚠️ السبب: خطأ في الاتصال بالخادم
   🔄 المحاولات: 2
   📅 التاريخ: 2024-01-15 12:34:56
```

### حالة الاتصال:
```
🔗 حالة الاتصال:
✅ الاتصال بـ API يعمل بشكل صحيح
📡 رمز الحالة: 201
```

## إعادة المحاولة للطلبات الفاشلة 🔄

### زر إعادة المحاولة:
- يظهر في صفحة حالة API عند وجود طلبات فاشلة
- يقوم بإعادة إرسال جميع الطلبات الفاشلة
- يعرض تقرير بالنتائج

### تقرير إعادة المحاولة:
```
🔄 إعادة المحاولة للطلبات الفاشلة
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 النتائج:
✅ نجح: 2 طلب
❌ فشل: 1 طلب
📋 إجمالي: 3 طلب

🎉 تم إعادة إرسال بعض الطلبات بنجاح!
⚠️ 1 طلب لا يزال فاشلاً
```

## إدارة قاعدة البيانات 🗄️

### الجداول الجديدة:

#### جدول `api_orders`:
```sql
CREATE TABLE api_orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    invoice_id INTEGER,
    receipt_number TEXT,
    api_order_id INTEGER,
    api_order_group_id TEXT,
    api_status TEXT,
    api_message TEXT,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    retry_count INTEGER DEFAULT 0,
    last_retry TIMESTAMP,
    FOREIGN KEY (invoice_id) REFERENCES invoices (id)
);
```

### الدوال الجديدة في DatabaseManager:

- `record_api_order()`: تسجيل نتيجة إرسال الطلب
- `get_api_order_status()`: الحصول على حالة الطلب
- `get_failed_api_orders()`: الحصول على الطلبات الفاشلة
- `update_api_order_retry()`: تحديث عدد المحاولات
- `get_invoice_by_receipt()`: الحصول على بيانات الفاتورة

## استكشاف الأخطاء وإصلاحها 🔧

### مشاكل شائعة:

1. **خطأ في الاتصال**:
   - تحقق من صحة الرابط في `API_BASE_URL`
   - تحقق من اتصال الإنترنت
   - تحقق من إعدادات الجدار الناري

2. **خطأ في المصادقة**:
   - تحقق من صحة `API_USERNAME` و `API_PASSWORD`
   - تأكد من أن الحساب مفعل في النظام الخارجي

3. **خطأ في البيانات**:
   - تحقق من تنسيق البيانات المرسلة
   - تأكد من وجود جميع الحقول المطلوبة

### اختبار الاتصال:
```bash
python test_api_connection.py
```

### إلغاء تفعيل API مؤقتاً:
```python
# في config.py
API_ENABLED = False
```

## الأمان 🔐

### إعدادات الأمان:
- استخدام HTTPS للاتصال
- تخزين بيانات الاعتماد في ملف config منفصل
- تسجيل جميع محاولات الاتصال
- مهلة زمنية للاتصال لمنع التعليق

### توصيات:
- تغيير كلمة المرور بانتظام
- مراقبة سجلات الاتصال
- استخدام VPN إذا لزم الأمر
- نسخ احتياطية لقاعدة البيانات

## التطوير المستقبلي 🚀

### الميزات المخطط لها:
- إرسال تحديثات حالة الطلب
- مزامنة البيانات ثنائية الاتجاه
- إشعارات فورية لحالة الطلب
- واجهة إدارة متقدمة لـ API
- دعم متعدد للأنظمة الخارجية

### التحسينات:
- تحسين أداء الاتصال
- إضافة المزيد من خيارات التكوين
- تحسين رسائل الخطأ
- إضافة إحصائيات مفصلة

## الدعم والمساعدة 💬

### للمساعدة:
- راجع هذا الدليل أولاً
- اختبر الاتصال باستخدام `test_api_connection.py`
- تحقق من سجلات البوت للأخطاء
- راجع إعدادات `config.py`

### التواصل:
- للمشاكل التقنية: راجع ملف `TROUBLESHOOTING.md`
- للاقتراحات: أرسل رسالة للمطور
- للتحديثات: تابع المستودع بانتظام
