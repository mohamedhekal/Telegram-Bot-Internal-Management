#!/bin/bash

# ุณูุฑูุจุช ูุดุฑ ูุชุดุบูู ุงูุจูุช ุนูู ุงูุณูุฑูุฑ ุงูุฌุฏูุฏ
# Server: 31.97.233.18
# Path: /var/www/leads_rockli_usr/data/www/leads.rocklis.com

echo "๐ ุจุฏุก ูุดุฑ ุงูุจูุช ุนูู ุงูุณูุฑูุฑ ุงูุฌุฏูุฏ..."
echo "=================================="

# ุชุญุฏูุฏ ุงููุณุงุฑ
SERVER_PATH="/var/www/leads_rockli_usr/data/www/leads.rocklis.com"
SERVER_IP="31.97.233.18"

echo "๐ ุงููุณุงุฑ: $SERVER_PATH"
echo "๐ ุงูุณูุฑูุฑ: $SERVER_IP"

# ุงูุชุญูู ูู ูุฌูุฏ Python3
echo "๐ ุงูุชุญูู ูู Python3..."
if ! command -v python3 &> /dev/null; then
    echo "โ Python3 ุบูุฑ ูุซุจุช"
    echo "๐ก ูู ุจุชุซุจูุช Python3 ุฃููุงู:"
    echo "   sudo apt update && sudo apt install python3 python3-pip"
    exit 1
fi
echo "โ Python3 ูุซุจุช"

# ุงูุชุญูู ูู ูุฌูุฏ pip3
echo "๐ ุงูุชุญูู ูู pip3..."
if ! command -v pip3 &> /dev/null; then
    echo "โ pip3 ุบูุฑ ูุซุจุช"
    echo "๐ก ูู ุจุชุซุจูุช pip3 ุฃููุงู:"
    echo "   sudo apt install python3-pip"
    exit 1
fi
echo "โ pip3 ูุซุจุช"

# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน
echo "๐ ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน..."
cd "$SERVER_PATH" || {
    echo "โ ูุดู ูู ุงูุงูุชูุงู ุฅูู $SERVER_PATH"
    exit 1
}
echo "โ ุชู ุงูุงูุชูุงู ุฅูู $SERVER_PATH"

# ุฅูุดุงุก ุจูุฆุฉ ุงูุชุฑุงุถูุฉ (ุงุฎุชูุงุฑู)
echo "๐ง ุฅูุดุงุก ุจูุฆุฉ ุงูุชุฑุงุถูุฉ..."
if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo "โ ุชู ุฅูุดุงุก ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ"
else
    echo "โ ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ููุฌูุฏุฉ"
fi

# ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ
echo "๐ง ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ..."
source venv/bin/activate
echo "โ ุชู ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ"

# ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ
echo "๐ฆ ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ..."
pip3 install --upgrade pip
pip3 install -r requirements.txt
echo "โ ุชู ุชุซุจูุช ุงูููุชุจุงุช"

# ุงูุชุญูู ูู ููู ุงูุฅุนุฏุงุฏุงุช
echo "๐ ุงูุชุญูู ูู ููู ุงูุฅุนุฏุงุฏุงุช..."
if [ ! -f "config.py" ]; then
    echo "โ ููู config.py ุบูุฑ ููุฌูุฏ"
    exit 1
fi
echo "โ ููู ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏ"

# ุฅููุงู ุงูุจูุชุงุช ุงูุฌุงุฑูุฉ
echo "๐ ุฅููุงู ุงูุจูุชุงุช ุงูุฌุงุฑูุฉ..."
pkill -f "python.*bot_clean" || true
pkill -f "python.*start_bot" || true
sleep 2
echo "โ ุชู ุฅููุงู ุงูุจูุชุงุช ุงูุฌุงุฑูุฉ"

# ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
echo "๐ ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุจูุช..."
python3 test_bot_token.py
if [ $? -ne 0 ]; then
    echo "โ ูุดู ูู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู"
    echo "๐ก ุชุฃูุฏ ูู ุตุญุฉ ุงูุชููู ูู config.py"
    exit 1
fi
echo "โ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ูุงุฌุญ"

# ุชุดุบูู ุงูุจูุช ูู ุงูุฎูููุฉ
echo "๐ ุชุดุบูู ุงูุจูุช..."
nohup python3 start_bot.py > bot.log 2>&1 &
BOT_PID=$!
echo "โ ุงูุจูุช ูุนูู ูู ุงูุฎูููุฉ (PID: $BOT_PID)"

# ุญูุธ ูุนุฑู ุงูุนูููุฉ
echo $BOT_PID > bot.pid
echo "โ ุชู ุญูุธ ูุนุฑู ุงูุนูููุฉ ูู bot.pid"

# ุงูุชุธุงุฑ ูููู ููุชุฃูุฏ ูู ุงูุชุดุบูู
sleep 5

# ุงูุชุญูู ูู ุฃู ุงูุจูุช ูุนูู
if ps -p $BOT_PID > /dev/null; then
    echo "๐ ุงูุจูุช ูุนูู ุจูุฌุงุญ!"
    echo "๐ฑ ููููู ุงูุขู ุงุณุชุฎุฏุงู ุงูุจูุช ูู ุชูููุฌุฑุงู"
    echo "๐ ููุฑุงูุจุฉ ุงูุณุฌูุงุช: tail -f bot.log"
    echo "๐ ูุฅููุงู ุงูุจูุช: kill $BOT_PID"
else
    echo "โ ูุดู ูู ุชุดุบูู ุงูุจูุช"
    echo "๐ ุฑุงุฌุน ุงูุณุฌูุงุช: cat bot.log"
    exit 1
fi

echo "=================================="
echo "โ ุชู ูุดุฑ ุงูุจูุช ุจูุฌุงุญ ุนูู ุงูุณูุฑูุฑ!"
echo "๐ ุงูุณูุฑูุฑ: $SERVER_IP"
echo "๐ ุงููุณุงุฑ: $SERVER_PATH"
